// AI CODE MENTOR - Sandbox Lesson Generation Endpoint 
// MISI√ìN 147 FASE 1: Corrige estructura de quizzes para eliminaci√≥n de pre-resoluci√≥n
// MISI√ìN 146.5 FASE 2: Genera lecciones con persistencia en Supabase
// MISI√ìN 147.6 COMPLETADA: Sistema de Prompts Contextuales - Meta-Prompts especializados por contexto pedag√≥gico
// MISI√ìN 147.9 COMPLETADA: Reparaci√≥n del Motor de Contexto Curricular
// MISI√ìN 147.12 COMPLETADA: Protocolo de Refuerzo de Directivas - Reglas No Negociables implementadas
// MISI√ìN 147.13 COMPLETADA: Correcci√≥n de Sintaxis en Meta-Prompts - Template Literals corregidos
// MISI√ìN 147.14 COMPLETADA: Reparaci√≥n de la L√≥gica de Reemplazo de Plantillas - Reemplazo global implementado
// üöÄ MISI√ìN 154 COMPLETADA: INTEGRACI√ìN DEL N√öCLEO RAG - Motor RAG completamente integrado
//   ‚úÖ retrieve_sources() integrado como primera operaci√≥n del endpoint
//   ‚úÖ Prompt Augmentation con contexto curricular completo y autoritativo
//   ‚úÖ Reemplazo completo de l√≥gica heredada curriculumMap por Motor RAG
//   ‚úÖ Meta-prompts enriquecidos con informaci√≥n curricular detallada
//   ‚úÖ Logging RAG espec√≠fico para observabilidad completa
//   ‚úÖ Retrocompatibilidad preservada para casos sin par√°metros de contexto
// üöÄ MISI√ìN 166 COMPLETADA: INTEGRACI√ìN ARM EXTERNO - ARM completamente funcional
//   ‚úÖ ARM (M√≥dulo de Recuperaci√≥n Activa) integrado con Motor RAG
//   ‚úÖ Cache Hit/Cache Miss ‚Üí Recuperador ‚Üí Extractor ‚Üí Cach√© implementado
//   ‚úÖ Fuentes externas oficiales (URLs) enriquecen contexto curricular
//   ‚úÖ Meta-prompts ARM-Enhanced con contenido de URLs oficiales
//   ‚úÖ Tabla source_content_cache para persistencia de contenido externo
//   ‚úÖ Fallback resiliente: ARM falla ‚Üí contexto b√°sico RAG se mantiene

import { withOptionalAuth } from '../../utils/authMiddleware';
import { getAuthenticatedSupabaseFromRequest } from '../../lib/supabaseServerAuth.js';
// üöÄ MISI√ìN 154: INTEGRACI√ìN MOTOR RAG
import { retrieve_sources } from '../../lib/rag/retrieve-sources.js';

// MISI√ìN 154: FUNCI√ìN DEPRECADA - Reemplazada por Motor RAG retrieve_sources()
// Mantenida solo para retrocompatibilidad en casos sin par√°metros de contexto
const getCurriculumInfoLegacy = (semanaId) => {
  console.warn(`‚ö†Ô∏è [LEGACY] Usando curriculumMap est√°tico para semana ${semanaId} (sin contexto RAG)`);
  
  // Mapeo b√°sico heredado - Solo para fallback
  const curriculumMap = {
    1: { tema: "Teor√≠a y √âtica de IA", fase: "Fase 0: Cimentaci√≥n del Arquitecto" },
    2: { tema: "Pr√°ctica de Dise√±o de Prompts", fase: "Fase 0: Cimentaci√≥n del Arquitecto" },
    3: { tema: "CS50 - Semana 0: Introducci√≥n", fase: "Fase 0: Cimentaci√≥n del Arquitecto" },
    25: { tema: "Programaci√≥n Orientada a Objetos - Conceptos Fundamentales", fase: "Fase 1: Fundamentos de Programaci√≥n" },
    50: { tema: "Fundamentos de Node.js - Profundizaci√≥n", fase: "Fase 3: Desarrollo Backend Profesional" },
    75: { tema: "Fundamentos de Cloud Computing (AWS/GCP)", fase: "Fase 4: DevOps y Cloud Computing" },
    100: { tema: "Contribuci√≥n Open Source y Crecimiento Continuo", fase: "Fase 7: Profesionalizaci√≥n y Crecimiento Continuo" },
    default: { tema: "Desarrollo de Software", fase: "Ecosistema 360" }
  };

  return curriculumMap[semanaId] || curriculumMap.default;
};

// MISI√ìN 154 + 166: FUNCI√ìN RAG + ARM EXTERNO - Obtiene contexto curricular con fuentes externas
const getCurriculumInfoRAG = async (semanaId) => {
  try {
    console.log(`üîç [RAG+ARM] Recuperando contexto curricular con fuentes externas para semana ${semanaId}...`);
    
    // PRIMERA OPERACI√ìN: Invocar Motor RAG + ARM Externo (includeExternalSources = true)
    const ragContext = await retrieve_sources(semanaId, true);
    
    console.log(`‚úÖ [RAG+ARM] Contexto recuperado exitosamente:`);
    console.log(`   üìö T√≠tulo: "${ragContext.weekTitle}"`);
    console.log(`   üéØ Fase: ${ragContext.phase} - ${ragContext.phaseTitle}`);
    console.log(`   üìò M√≥dulo: ${ragContext.module} - ${ragContext.moduleTitle}`);
    console.log(`   üè∑Ô∏è Enfoque Pedag√≥gico: ${ragContext.pedagogicalApproach}`);
    console.log(`   üìä Nivel Dificultad: ${ragContext.difficultyLevel}`);
    console.log(`   üìã Objetivos: ${ragContext.objectives.length}`);
    console.log(`   üì¶ Recursos: ${ragContext.resources.length}`);
    console.log(`   üéì Prerequisitos: ${ragContext.prerequisites.length}`);
    
    // MISI√ìN 166: Logging ARM espec√≠fico
    if (ragContext.armStatus === 'enriched' && ragContext.externalSources?.length > 0) {
      console.log(`   üåê [ARM] Fuentes externas: ${ragContext.externalSources.length} procesadas`);
      console.log(`   ‚ö° [ARM] Cache hits: ${ragContext.armMetadata.cacheHits}/${ragContext.armMetadata.totalUrls}`);
      console.log(`   üïê [ARM] Tiempo total: ${ragContext.armMetadata.totalProcessTimeMs}ms`);
      
      ragContext.externalSources.forEach((source, index) => {
        console.log(`      ${index + 1}. ${source.type}: ${source.name} (${source.fromCache ? 'cached' : 'fresh'})`);
      });
    } else if (ragContext.armStatus === 'no-external-sources') {
      console.log(`   ‚ÑπÔ∏è [ARM] No hay fuentes externas para esta semana`);
    } else if (ragContext.armStatus === 'error') {
      console.warn(`   ‚ö†Ô∏è [ARM] Error procesando fuentes externas: ${ragContext.armError}`);
    }
    
    // Devolver formato compatible con funci√≥n legacy
    return {
      tema: ragContext.weekTitle,
      fase: `Fase ${ragContext.phase}: ${ragContext.phaseTitle.replace(/^Fase \d+: /, '')}`,
      // Contexto RAG enriquecido adicional
      ragContext: ragContext
    };
    
  } catch (error) {
    console.error(`‚ùå [RAG ERROR] Error recuperando contexto para semana ${semanaId}:`, error.message);
    
    // Fallback a funci√≥n legacy en caso de error RAG
    console.warn(`üîÑ [FALLBACK] Usando curriculumMap legacy para semana ${semanaId}`);
    return getCurriculumInfoLegacy(semanaId);
  }
};

// Funci√≥n para obtener prop√≥sito del pomodoro seg√∫n su √≠ndice
const getPomodoroContext = (pomodoroIndex) => {
  // Mapeo basado en la estructura del WeeklySchedule
  const pomodoroContextMap = {
    0: {
      tipo: "teorico",
      proposito: "Estudio del concepto te√≥rico del d√≠a - Adquisici√≥n de conocimiento fundamental"
    },
    1: {
      tipo: "teorico", 
      proposito: "Pr√°ctica guiada y experimentaci√≥n con el c√≥digo - Consolidaci√≥n te√≥rica"
    },
    2: {
      tipo: "evaluativo",
      proposito: "Resoluci√≥n de ejercicios nuevos - Aplicaci√≥n pr√°ctica de conocimientos"
    },
    3: {
      tipo: "evaluativo",
      proposito: "Continuaci√≥n de problemas y revisi√≥n - Integraci√≥n y evaluaci√≥n"
    }
  };

  return pomodoroContextMap[pomodoroIndex] || pomodoroContextMap[0];
};

// MISI√ìN 154: META-PROMPT TE√ìRICO RAG-ENHANCED v2.0 - Para pomodoros 0 y 1 (Adquisici√≥n de Conocimiento)
// Enriquecido con contexto curricular completo del Motor RAG
const META_PROMPT_TEORICO_RAG = `
Act√∫a como un mentor y arquitecto de sistemas senior del "Ecosistema 360".
Tu tarea es generar el contenido para un micro-m√≥dulo de estudio.

**CONTEXTO CURRICULAR AUTORITATIVO (Motor RAG):**
Semana {SEMANA_ID}: {TEMA_DE_LA_SEMANA}
Fase Curricular: {FASE_CURRICULAR} 
M√≥dulo: {MODULO_TITULO}
Enfoque Pedag√≥gico: {ENFOQUE_PEDAGOGICO}
Nivel de Dificultad: {NIVEL_DIFICULTAD}
Objetivo Espec√≠fico de este Bloque: {PROPOSITO_DEL_POMODORO}

**OBJETIVOS PEDAG√ìGICOS DE LA SEMANA:**
{OBJETIVOS_SEMANA}

**TEM√ÅTICA ESPEC√çFICA:**
{TEMATICA_DETALLADA}

**ACTIVIDADES PROGRAMADAS:**
{ACTIVIDADES_SEMANA}

**PREREQUISITOS CURRICULARES:**
{PREREQUISITOS_CONTEXTO}

**FUENTES OFICIALES EXTERNAS (ARM):**
{FUENTES_EXTERNAS_ARM}

**Reglas No Negociables:**
1.  **RESTRICCI√ìN DE TEMA:** Todo el contenido que generes, tanto la lecci√≥n como los ejercicios, debe estar **estricta y exclusivamente** relacionado con el **"Tema Principal de la Semana"** (\`{TEMA_DE_LA_SEMANA}\`).
2.  **ALINEACI√ìN CURRICULAR:** El contenido debe alinearse perfectamente con los objetivos pedag√≥gicos, el nivel de dificultad ({NIVEL_DIFICULTAD}) y el enfoque ({ENFOQUE_PEDAGOGICO}) especificados.
3.  **COHERENCIA DE PREREQUISITOS:** Considera los prerequisitos curriculares mencionados para asegurar progresi√≥n pedag√≥gica apropiada.
4.  **PROHIBICI√ìN DE TEMAS EXTERNOS:** Queda terminantemente prohibido introducir o generar contenido sobre cualquier otro tema, aunque est√© vagamente relacionado.
5.  **VALIDACI√ìN:** Antes de responder, verifica internamente que tu contenido cumple al 100% con todas las restricciones.

**TAREA PRINCIPAL:**

1. Genera el "Contenido de la Lecci√≥n":
Crea un contenido sustancial que cumpla estrictamente con el Objetivo Espec√≠fico y los objetivos pedag√≥gicos de la semana.
- Profundidad: El contenido debe ser adecuado para 45 minutos de estudio (500-700 palabras), ajustado al nivel de dificultad {NIVEL_DIFICULTAD}.
- Estructura: Organ√≠zalo con subt√≠tulos claros que reflejen el enfoque {ENFOQUE_PEDAGOGICO}.
- Componentes Obligatorios: Debe incluir explicaciones conceptuales alineadas con la tem√°tica, al menos dos ejemplos pr√°cticos espec√≠ficos al tema (c√≥digo si aplica), y una analog√≠a que facilite la comprensi√≥n.
- Contexto Pedag√≥gico: Integra sutilmente referencias a los prerequisitos cuando sea apropiado.

2. Genera los "Ejercicios de Pr√°ctica":
A continuaci√≥n, genera un quiz de 3 preguntas de opci√≥n m√∫ltiple para evaluar la comprensi√≥n del contenido, adaptadas al nivel de dificultad especificado.

Formato de Salida Obligatorio: Devuelve un √∫nico objeto JSON. La lecci√≥n en 'content.lesson' y el quiz en 'content.quiz'. El quiz debe seguir la estructura: [{ "question": "...", "options": [...], "correctAnswerIndex": N, "explanation": "..." }].
`;

// MISI√ìN 154: META-PROMPT EVALUATIVO RAG-ENHANCED v2.0 - Para pomodoros 2 y 3 (Aplicaci√≥n y Resoluci√≥n de Problemas)  
// Enriquecido con contexto curricular completo del Motor RAG
const META_PROMPT_EVALUATIVO_RAG = `
Act√∫a como un examinador que dise√±a evaluaciones para validar la comprensi√≥n y aplicaci√≥n del conocimiento dentro del "Ecosistema 360".

**CONTEXTO CURRICULAR AUTORITATIVO (Motor RAG):**
Semana {SEMANA_ID}: {TEMA_DE_LA_SEMANA}
Fase Curricular: {FASE_CURRICULAR}
M√≥dulo: {MODULO_TITULO}
Enfoque Pedag√≥gico: {ENFOQUE_PEDAGOGICO}
Nivel de Dificultad: {NIVEL_DIFICULTAD}
Objetivo Espec√≠fico de este Bloque: {PROPOSITO_DEL_POMODORO}

**OBJETIVOS PEDAG√ìGICOS DE LA SEMANA:**
{OBJETIVOS_SEMANA}

**TEM√ÅTICA ESPEC√çFICA:**
{TEMATICA_DETALLADA}

**ENTREGABLES ESPERADOS:**
{ENTREGABLES_SEMANA}

**PREREQUISITOS CURRICULARES:**
{PREREQUISITOS_CONTEXTO}

**Reglas No Negociables:**
1.  **RESTRICCI√ìN DE TEMA:** Todo el contenido que generes, tanto la lecci√≥n como los ejercicios, debe estar **estricta y exclusivamente** relacionado con el **"Tema Principal de la Semana"** (\`{TEMA_DE_LA_SEMANA}\`).
2.  **EVALUACI√ìN CONTEXTUAL:** Las preguntas deben evaluar espec√≠ficamente los objetivos pedag√≥gicos definidos para esta semana.
3.  **NIVEL APROPIADO:** La complejidad debe corresponder exactamente al nivel de dificultad {NIVEL_DIFICULTAD} y enfoque {ENFOQUE_PEDAGOGICO}.
4.  **APLICACI√ìN REAL:** Incluye escenarios que reflejen los entregables esperados de la semana.
5.  **PROGRESI√ìN CURRICULAR:** Considera los prerequisitos para crear preguntas que demuestren progresi√≥n apropiada.
6.  **VALIDACI√ìN:** Antes de responder, verifica internamente que tu contenido cumple al 100% con todas las restricciones.

**TAREA PRINCIPAL:**

Tu tarea es generar exclusivamente una secci√≥n de "Ejercicios de Pr√°ctica".
Genera un quiz de 3 preguntas de opci√≥n m√∫ltiple sobre el tema principal, espec√≠ficamente dise√±adas para evaluar los objetivos pedag√≥gicos de la semana. Estas preguntas deben evaluar diferentes niveles de comprensi√≥n, siguiendo la Taxonom√≠a de Bloom y adaptadas al nivel {NIVEL_DIFICULTAD}:

1.  Una pregunta de 'Recordar' - enfocada en conceptos clave del tema principal.
2.  Una pregunta de 'Comprender' - que eval√∫e la comprensi√≥n profunda de los objetivos pedag√≥gicos.
3.  Una pregunta de 'Aplicar' o 'Analizar' - presentando un escenario realista relacionado con los entregables esperados.

Para cada pregunta, las opciones incorrectas (distractores) deben ser plausibles y relacionarse con errores comunes en este nivel de dificultad, considerando el contexto de prerequisitos.

Formato de Salida Obligatorio: Devuelve un √∫nico objeto JSON. El quiz en 'content.quiz' y el campo 'content.lesson' debe contener un texto breve que introduzca los ejercicios en el contexto curricular apropiado. El quiz debe seguir la estructura: [{ "question": "...", "options": [...], "correctAnswerIndex": N, "explanation": "..." }].
`;

// MISI√ìN 154: FUNCI√ìN PRINCIPAL RAG-ENHANCED - Genera prompt con contexto curricular completo
const generateContextualPromptRAG = async (semanaId, pomodoroIndex, inputText) => {
  console.log(`üöÄ [RAG PROMPT] Iniciando generaci√≥n de prompt contextual para semana ${semanaId}, pomodoro ${pomodoroIndex}`);
  
  try {
    // PASO 1: Obtener contexto curricular completo del Motor RAG
    const curriculumInfo = await getCurriculumInfoRAG(semanaId);
    const pomodoroContext = getPomodoroContext(pomodoroIndex);
    
    // PASO 2: Seleccionar plantilla RAG-Enhanced seg√∫n pomodoroIndex
    let selectedPrompt;
    if (pomodoroIndex === 0 || pomodoroIndex === 1) {
      selectedPrompt = META_PROMPT_TEORICO_RAG;
      console.log(`üéØ [RAG] Prompt seleccionado: META_PROMPT_TEORICO_RAG para pomodoro ${pomodoroIndex} (Adquisici√≥n de Conocimiento)`);
    } else if (pomodoroIndex === 2 || pomodoroIndex === 3) {
      selectedPrompt = META_PROMPT_EVALUATIVO_RAG;
      console.log(`üéØ [RAG] Prompt seleccionado: META_PROMPT_EVALUATIVO_RAG para pomodoro ${pomodoroIndex} (Aplicaci√≥n y Resoluci√≥n de Problemas)`);
    } else {
      selectedPrompt = META_PROMPT_TEORICO_RAG;
      console.warn(`‚ö†Ô∏è [RAG] pomodoroIndex ${pomodoroIndex} fuera de rango, usando META_PROMPT_TEORICO_RAG por defecto`);
    }
    
    // PASO 3: Construir contexto enriquecido si tenemos informaci√≥n RAG
    let enrichedPrompt;
    if (curriculumInfo.ragContext) {
      const ragCtx = curriculumInfo.ragContext;
      
      // Construir strings contextuales para el prompt
      const objetivosText = ragCtx.objectives && ragCtx.objectives.length > 0 
        ? ragCtx.objectives.map((obj, i) => `${i + 1}. ${obj}`).join('\n')
        : 'Objetivos espec√≠ficos definidos en el curr√≠culum para esta semana.';
        
      const actividadesText = ragCtx.activities && ragCtx.activities.length > 0
        ? ragCtx.activities.map((act, i) => `${i + 1}. ${act}`).join('\n')
        : 'Actividades espec√≠ficas programadas para esta semana.';
        
      const prerequisitosText = ragCtx.prerequisites && ragCtx.prerequisites.length > 0
        ? ragCtx.prerequisites.map(prereq => `‚Ä¢ Semana ${prereq.weekId}: ${prereq.title}`).join('\n')
        : 'Esta es una semana inicial sin prerequisitos espec√≠ficos.';
        
      // MISI√ìN 166: Construir texto de fuentes externas ARM
      const fuentesExternasText = ragCtx.externalSources && ragCtx.externalSources.length > 0
        ? ragCtx.externalSources.map((source, index) => {
            const contentPreview = source.content ? source.content.substring(0, 500) + '...' : '';
            return `${index + 1}. **${source.name}** (${source.type}):\n   Fuente: ${source.url}\n   Contenido relevante extra√≠do: ${contentPreview}`;
          }).join('\n\n')
        : 'No hay fuentes externas disponibles para esta semana.';
      
      // PASO 4: Poblar plantilla RAG + ARM con contexto completo (reemplazo global)
      enrichedPrompt = selectedPrompt
        .replace(/{SEMANA_ID}/g, semanaId.toString())
        .replace(/{TEMA_DE_LA_SEMANA}/g, ragCtx.weekTitle)
        .replace(/{FASE_CURRICULAR}/g, `Fase ${ragCtx.phase}: ${ragCtx.phaseTitle}`)
        .replace(/{MODULO_TITULO}/g, `M√≥dulo ${ragCtx.module}: ${ragCtx.moduleTitle}`)
        .replace(/{ENFOQUE_PEDAGOGICO}/g, ragCtx.pedagogicalApproach)
        .replace(/{NIVEL_DIFICULTAD}/g, ragCtx.difficultyLevel)
        .replace(/{PROPOSITO_DEL_POMODORO}/g, pomodoroContext.proposito)
        .replace(/{OBJETIVOS_SEMANA}/g, objetivosText)
        .replace(/{TEMATICA_DETALLADA}/g, ragCtx.mainTopic || ragCtx.weekTitle)
        .replace(/{ACTIVIDADES_SEMANA}/g, actividadesText)
        .replace(/{ENTREGABLES_SEMANA}/g, ragCtx.deliverables || 'Entregables espec√≠ficos seg√∫n curr√≠culum.')
        .replace(/{PREREQUISITOS_CONTEXTO}/g, prerequisitosText)
        .replace(/{FUENTES_EXTERNAS_ARM}/g, fuentesExternasText);
        
      console.log(`‚úÖ [RAG] Prompt enriquecido con contexto curricular completo:`);
      console.log(`   üìö Semana: ${ragCtx.weekTitle}`);
      console.log(`   üéØ Enfoque: ${ragCtx.pedagogicalApproach}`);
      console.log(`   üìä Nivel: ${ragCtx.difficultyLevel}`);
      console.log(`   üìã Objetivos: ${ragCtx.objectives.length} espec√≠ficos`);
      console.log(`   üîó Prerequisitos: ${ragCtx.prerequisites.length} previos`);
      
    } else {
      // Fallback: usar informaci√≥n b√°sica del curriculum legacy
      console.warn(`‚ö†Ô∏è [RAG FALLBACK] Sin contexto RAG, usando informaci√≥n b√°sica`);
      enrichedPrompt = selectedPrompt
        .replace(/{SEMANA_ID}/g, semanaId.toString())
        .replace(/{TEMA_DE_LA_SEMANA}/g, curriculumInfo.tema)
        .replace(/{FASE_CURRICULAR}/g, curriculumInfo.fase)
        .replace(/{MODULO_TITULO}/g, 'M√≥dulo espec√≠fico del curr√≠culum')
        .replace(/{ENFOQUE_PEDAGOGICO}/g, 'Enfoque pedag√≥gico apropiado')
        .replace(/{NIVEL_DIFICULTAD}/g, 'Nivel apropiado para la semana')
        .replace(/{PROPOSITO_DEL_POMODORO}/g, pomodoroContext.proposito)
        .replace(/{OBJETIVOS_SEMANA}/g, 'Objetivos espec√≠ficos para esta semana')
        .replace(/{TEMATICA_DETALLADA}/g, curriculumInfo.tema)
        .replace(/{ACTIVIDADES_SEMANA}/g, 'Actividades espec√≠ficas programadas')
        .replace(/{ENTREGABLES_SEMANA}/g, 'Entregables espec√≠ficos de la semana')
        .replace(/{PREREQUISITOS_CONTEXTO}/g, 'Prerequisitos apropiados para la progresi√≥n')
        .replace(/{FUENTES_EXTERNAS_ARM}/g, 'No hay fuentes externas disponibles.');
    }
    
    console.log(`üîß [RAG] Contexto pedag√≥gico aplicado:`);
    console.log(`   - Semana ${semanaId}: ${curriculumInfo.tema}`);
    console.log(`   - Fase: ${curriculumInfo.fase}`);
    console.log(`   - Pomodoro ${pomodoroIndex}: ${pomodoroContext.proposito}`);
    console.log(`   - Tipo de prompt: ${pomodoroContext.tipo} (RAG-Enhanced)`);
    
    return enrichedPrompt;
    
  } catch (error) {
    console.error(`‚ùå [RAG ERROR] Error generando prompt contextual:`, error.message);
    
    // Fallback completo: usar funci√≥n legacy original
    console.warn(`üîÑ [COMPLETE FALLBACK] Usando generateContextualPromptLegacy`);
    return generateContextualPromptLegacy(semanaId, pomodoroIndex, inputText);
  }
};

// FUNCI√ìN LEGACY PRESERVADA para casos de fallback
const generateContextualPromptLegacy = (semanaId, pomodoroIndex, inputText) => {
  console.warn(`‚ö†Ô∏è [LEGACY PROMPT] Generando prompt con curriculumMap est√°tico`);
  
  const curriculumInfo = getCurriculumInfoLegacy(semanaId);
  const pomodoroContext = getPomodoroContext(pomodoroIndex);
  
  // Meta-prompts originales (versiones b√°sicas)
  const META_PROMPT_TEORICO_BASIC = `
Act√∫a como un mentor y arquitecto de sistemas senior del "Ecosistema 360".
Tu tarea es generar el contenido para un micro-m√≥dulo de estudio.

Tema Principal de la Semana: {TEMA_DE_LA_SEMANA}
Objetivo Espec√≠fico de este Bloque: {PROPOSITO_DEL_POMODORO}

1. Genera el "Contenido de la Lecci√≥n":
- Profundidad: 500-700 palabras para 45 minutos de estudio.
- Estructura: Subt√≠tulos claros + explicaciones conceptuales.
- Componentes: 2+ ejemplos pr√°cticos + analog√≠a obligatoria.

2. Genera los "Ejercicios de Pr√°ctica":
Quiz de 3 preguntas de opci√≥n m√∫ltiple para evaluaci√≥n.

Formato: content.lesson y content.quiz en JSON estructurado.
`;

  const META_PROMPT_EVALUATIVO_BASIC = `
Act√∫a como un examinador que dise√±a evaluaciones para validar comprensi√≥n del "Ecosistema 360".

Tema Principal de la Semana: {TEMA_DE_LA_SEMANA}
Objetivo Espec√≠fico de este Bloque: {PROPOSITO_DEL_POMODORO}

Genera quiz de 3 preguntas con Taxonom√≠a de Bloom:
1. Pregunta de 'Recordar'
2. Pregunta de 'Comprender'  
3. Pregunta de 'Aplicar/Analizar' con escenario

Formato: content.quiz y content.lesson (introducci√≥n breve) en JSON.
`;

  let selectedPrompt = pomodoroIndex === 0 || pomodoroIndex === 1 
    ? META_PROMPT_TEORICO_BASIC 
    : META_PROMPT_EVALUATIVO_BASIC;
  
  return selectedPrompt
    .replace(/{TEMA_DE_LA_SEMANA}/g, curriculumInfo.tema)
    .replace(/{PROPOSITO_DEL_POMODORO}/g, pomodoroContext.proposito);
};

// Funci√≥n de validaci√≥n mejorada para nueva estructura
const validateExerciseStructure = (exercise) => {
  return exercise && 
         typeof exercise === 'object' && 
         exercise.question && 
         exercise.type === 'multiple_choice' && 
         Array.isArray(exercise.options) && 
         exercise.options.length === 4 &&
         typeof exercise.correctAnswerIndex === 'number' &&
         exercise.correctAnswerIndex >= 0 &&
         exercise.correctAnswerIndex <= 3 &&
         exercise.explanation;
};

// Handler principal
async function handler(req, res) {
  // Verificar m√©todo HTTP
  if (req.method !== 'POST') {
    return res.status(405).json({ 
      error: 'M√©todo no permitido',
      message: 'Este endpoint solo acepta solicitudes POST' 
    });
  }

  try {
    const { text, semanaId, diaIndex, pomodoroIndex } = req.body;

    // Validaci√≥n de entrada b√°sica
    if (!text) {
      return res.status(400).json({ 
        error: 'Texto requerido',
        message: 'El campo "text" es obligatorio' 
      });
    }

    if (typeof text !== 'string') {
      return res.status(400).json({ 
        error: 'Formato inv√°lido',
        message: 'El campo "text" debe ser una cadena de texto' 
      });
    }

    if (text.trim().length < 10) {
      return res.status(400).json({ 
        error: 'Texto muy corto',
        message: 'El texto debe tener al menos 10 caracteres' 
      });
    }

    if (text.length > 10000) {
      return res.status(400).json({ 
        error: 'Texto muy largo',
        message: 'El texto no puede exceder 10,000 caracteres' 
      });
    }

    // VALIDACI√ìN: Par√°metros de ubicaci√≥n para persistencia y contexto
    const hasLocationParams = semanaId !== undefined && diaIndex !== undefined && pomodoroIndex !== undefined;

    if (hasLocationParams) {
      // Si se proporcionan par√°metros de ubicaci√≥n, validarlos
      if (!Number.isInteger(semanaId) || semanaId < 1) {
        return res.status(400).json({
          error: 'semanaId inv√°lido',
          message: 'semanaId debe ser un entero positivo'
        });
      }

      if (!Number.isInteger(diaIndex) || diaIndex < 0 || diaIndex > 4) {
        return res.status(400).json({
          error: 'diaIndex inv√°lido', 
          message: 'diaIndex debe ser un entero entre 0 y 4'
        });
      }

      if (!Number.isInteger(pomodoroIndex) || pomodoroIndex < 0 || pomodoroIndex > 3) {
        return res.status(400).json({
          error: 'pomodoroIndex inv√°lido',
          message: 'pomodoroIndex debe ser un entero entre 0 y 3'
        });
      }
    }

    // Verificar API key de Gemini
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error('‚ùå API key de Gemini no configurada');
      return res.status(500).json({ 
        error: 'Configuraci√≥n del servidor',
        message: 'API de IA no configurada correctamente' 
      });
    }

    const { isAuthenticated, userId } = req.authContext;

    console.log(`üß™ Generando lecci√≥n${hasLocationParams ? ` RAG-contextual para semana ${semanaId}, d√≠a ${diaIndex}, pomodoro ${pomodoroIndex}` : ''} (${text.length} caracteres)`);

    // MISI√ìN 154: GENERAR PROMPT CON MOTOR RAG INTEGRADO
    let prompt;
    if (hasLocationParams) {
      // üöÄ NUEVA RUTA: Usar Motor RAG para prompt contextual enriquecido
      console.log(`üöÄ [RAG INTEGRATION] Iniciando generaci√≥n con Motor RAG...`);
      prompt = await generateContextualPromptRAG(semanaId, pomodoroIndex, text.trim());
      console.log(`‚úÖ [RAG] Usando prompt contextual RAG-Enhanced`);
    } else {
      // Fallback al prompt gen√©rico para retrocompatibilidad
      console.log(`‚ö†Ô∏è Sin par√°metros de contexto, usando prompt gen√©rico`);
      prompt = `Act√∫a como un dise√±ador instruccional experto creando un micro-m√≥dulo de aprendizaje para un estudiante autodidacta a partir del siguiente texto. Tu respuesta debe ser estrictamente en formato JSON.

TEXTO DEL USUARIO:
"""
${text.trim()}
"""

Basado en el texto anterior, genera el siguiente contenido estructurado en un objeto JSON con las claves "title", "lesson", y "exercises":

1.  "title": Un t√≠tulo conciso y atractivo para la lecci√≥n.
2.  "lesson": Un resumen explicativo del texto en no m√°s de 200 palabras, manteniendo un tono claro y did√°ctico.
3.  "exercises": Un array de 3 objetos de ejercicio, donde cada objeto debe tener las siguientes claves:
    * "question": Una pregunta que ponga a prueba la comprensi√≥n del texto.
    * "type": El tipo de ejercicio. Debe ser 'multiple_choice'.
    * "options": Un array de 4 strings con posibles respuestas (opciones A, B, C, D).
    * "correctAnswerIndex": Un n√∫mero entero (0, 1, 2, o 3) que indica el √≠ndice de la respuesta correcta en el array options.
    * "explanation": Una breve explicaci√≥n de por qu√© la respuesta es correcta.

IMPORTANTE: 
- Las opciones deben estar ordenadas l√≥gicamente y ser plausibles
- El correctAnswerIndex debe ser un n√∫mero entero, NO un string
- NO incluyas la palabra "correctAnswer" - solo usa "correctAnswerIndex"
- Los ejercicios deben ser espec√≠ficos al contenido del texto proporcionado

Responde SOLO con el objeto JSON v√°lido, sin texto adicional.`;
    }

    // üö® MISI√ìN 154: LOGGING DEBUG RAG - Mostrar prompt RAG-enhanced antes de env√≠o
    console.log(`\nüîç [DEBUG RAG INTEGRATION] PROMPT RAG-ENHANCED A ENVIAR A GEMINI:`);
    console.log(`================== INICIO PROMPT RAG ==================`);
    console.log(prompt);
    console.log(`================== FIN PROMPT RAG ===================\n`);
    
    // Verificar que las variables RAG se reemplazaron correctamente
    if (hasLocationParams && prompt.includes('{')) {
      const unreplacedVars = prompt.match(/{[A-Z_]+}/g);
      if (unreplacedVars) {
        console.error(`‚ùå [RAG ERROR CR√çTICO] Variables RAG no reemplazadas:`, unreplacedVars);
      } else {
        console.log(`‚úÖ [RAG] Todas las variables contextuales reemplazadas exitosamente`);
      }
    }

    // Llamar a la API de Gemini con prompt RAG-enhanced
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          maxOutputTokens: 1500,
          temperature: 0.4,
          candidateCount: 1
        }
      })
    });

    // Verificar respuesta de Gemini
    if (!response.ok) {
      console.error(`‚ùå Error de Gemini API: ${response.status} ${response.statusText}`);
      return res.status(500).json({ 
        error: 'Error del servicio de IA',
        message: `La API de IA respondi√≥ con estado ${response.status}` 
      });
    }

    const geminiData = await response.json();

    // Verificar estructura de respuesta
    if (!geminiData.candidates || !geminiData.candidates[0] || !geminiData.candidates[0].content) {
      console.error('‚ùå Respuesta inesperada de Gemini:', geminiData);
      return res.status(500).json({ 
        error: 'Respuesta inv√°lida de IA',
        message: 'El servicio de IA no devolvi√≥ el formato esperado' 
      });
    }

    const generatedText = geminiData.candidates[0].content.parts[0].text;

    // Intentar parsear JSON de la respuesta
    let lessonData;
    try {
      // Limpiar la respuesta para extraer solo el JSON
      const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        lessonData = JSON.parse(jsonMatch[0]);
      } else {
        // Si no hay JSON v√°lido, crear estructura b√°sica
        lessonData = {
          title: "Lecci√≥n Generada",
          lesson: generatedText,
          exercises: []
        };
      }
    } catch (parseError) {
      console.warn('‚ö†Ô∏è No se pudo parsear JSON de Gemini, usando texto plano:', parseError.message);
      // Fallback: crear estructura con el texto generado
      lessonData = {
        title: "Lecci√≥n Generada",
        lesson: generatedText,
        exercises: []
      };
    }

    // Procesamiento mejorado para manejar estructura JSON
    let extractedLesson, extractedExercises;
    
    if (lessonData.content) {
      // Formato nuevo: content.lesson y content.quiz
      extractedLesson = lessonData.content.lesson || lessonData.lesson || generatedText;
      extractedExercises = lessonData.content.quiz || lessonData.exercises || [];
      console.log('‚ú® [RAG] Procesando respuesta con formato content.lesson/content.quiz');
    } else {
      // Formato legacy: lesson y exercises
      extractedLesson = lessonData.lesson || generatedText;
      extractedExercises = lessonData.exercises || [];
      console.log('üîÑ [RAG] Procesando respuesta con formato legacy lesson/exercises');
    }

    // MISI√ìN 154: Construir respuesta enriquecida con contexto RAG
    const cleanedLesson = {
      title: lessonData.title || "Lecci√≥n Generada",
      lesson: extractedLesson,
      exercises: Array.isArray(extractedExercises) ? 
        extractedExercises.filter(ex => {
          // Usar funci√≥n de validaci√≥n
          const isValid = validateExerciseStructure(ex);
          if (!isValid) {
            console.warn('‚ö†Ô∏è Ejercicio descartado por estructura incorrecta:', {
              hasQuestion: !!ex?.question,
              hasType: ex?.type === 'multiple_choice',
              hasOptions: Array.isArray(ex?.options) && ex?.options?.length === 4,
              hasCorrectAnswerIndex: typeof ex?.correctAnswerIndex === 'number',
              correctAnswerIndexInRange: ex?.correctAnswerIndex >= 0 && ex?.correctAnswerIndex <= 3,
              hasExplanation: !!ex?.explanation
            });
          }
          return isValid;
        }).map(ex => ({
          ...ex,
          type: 'multiple_choice' // Asegurar que siempre tenga el tipo correcto
        })) : [],
      generatedAt: new Date().toISOString(),
      inputLength: text.length,
      // MISI√ìN 154: Metadatos RAG enriquecidos
      ...(hasLocationParams && {
        semanaId,
        diaIndex, 
        pomodoroIndex,
        contextInfo: {
          // Intentar obtener contexto RAG para metadatos
          curriculum: await getCurriculumInfoRAG(semanaId).catch(() => getCurriculumInfoLegacy(semanaId)),
          pomodoroContext: getPomodoroContext(pomodoroIndex),
          promptType: pomodoroIndex === 0 || pomodoroIndex === 1 ? 'teorico' : 'evaluativo',
          ragEnabled: true,
          ragVersion: 'v5.0'
        }
      })
    };

    // Log de validaci√≥n de ejercicios
    if (extractedExercises && extractedExercises.length > 0) {
      const originalCount = extractedExercises.length;
      const validCount = cleanedLesson.exercises.length;
      console.log(`üìä [RAG] Validaci√≥n ejercicios: ${validCount}/${originalCount} v√°lidos con correctAnswerIndex`);
      
      // Log detallado de ejercicios v√°lidos
      cleanedLesson.exercises.forEach((ex, index) => {
        console.log(`‚úÖ Ejercicio ${index + 1}: correctAnswerIndex=${ex.correctAnswerIndex} ‚Üí "${ex.options[ex.correctAnswerIndex]}"`);
      });
    }

    // Persistir en base de datos si el usuario est√° autenticado y se proporcionaron par√°metros de ubicaci√≥n
    if (isAuthenticated && hasLocationParams) {
      try {
        console.log(`üíæ [RAG] Persistiendo lecci√≥n RAG-contextual para usuario ${userId} en BD...`);
        
        const authenticatedSupabase = getAuthenticatedSupabaseFromRequest(req);
        
        // Insertar en tabla generated_content
        const { data: savedContent, error: saveError } = await authenticatedSupabase
          .from('generated_content')
          .insert({
            user_id: userId,
            semana_id: semanaId,
            dia_index: diaIndex,
            pomodoro_index: pomodoroIndex,
            content: cleanedLesson
          })
          .select()
          .single();

        if (saveError) {
          console.error('‚ö†Ô∏è Error guardando en BD (continuando con respuesta):', saveError);
          // No devolver error, solo log - la generaci√≥n fue exitosa
        } else {
          console.log(`‚úÖ [RAG] Lecci√≥n RAG-contextual persistida con ID: ${savedContent.id}`);
          cleanedLesson.savedToDatabase = true;
          cleanedLesson.contentId = savedContent.id;
        }

      } catch (persistError) {
        console.error('‚ö†Ô∏è Error en persistencia (continuando con respuesta):', persistError);
        // No devolver error, solo log - la generaci√≥n fue exitosa
      }
    }

    // MISI√ìN 154: Log diferenciado con informaci√≥n RAG
    const promptTypeUsed = cleanedLesson.contextInfo?.promptType || 'gen√©rico';
    const ragInfo = cleanedLesson.contextInfo?.ragEnabled ? ' (RAG-Enhanced)' : '';
    const contextualInfo = cleanedLesson.contextInfo?.curriculum ? 
      ` - ${cleanedLesson.contextInfo.curriculum.tema}` : '';
    
    console.log(`‚úÖ [RAG SUCCESS] Lecci√≥n generada con Motor RAG integrado:`);
    console.log(`   üéØ Prompt: ${promptTypeUsed}${ragInfo}`);
    console.log(`   üìö T√≠tulo: "${cleanedLesson.title}"`);
    console.log(`   üìù Ejercicios: ${cleanedLesson.exercises.length} interactivos`);
    console.log(`   üíæ Persistencia: ${cleanedLesson.savedToDatabase ? 'BD' : 'No'}${contextualInfo}`);

    // Respuesta exitosa con contexto RAG
    res.status(200).json(cleanedLesson);

  } catch (error) {
    console.error('‚ùå [RAG ERROR] Error interno generando lecci√≥n:', error);
    
    // Determinar tipo de error para respuesta apropiada
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      return res.status(500).json({ 
        error: 'Error de conectividad',
        message: 'No se pudo conectar con el servicio de IA' 
      });
    }

    res.status(500).json({ 
      error: 'Error interno del servidor',
      message: 'Ocurri√≥ un error inesperado al generar la lecci√≥n'
    });
  }
}

// Aplicar middleware de autenticaci√≥n opcional
export default withOptionalAuth(handler);
