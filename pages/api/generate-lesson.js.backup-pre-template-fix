// AI CODE MENTOR - Sandbox Lesson Generation Endpoint 
// MISIÃ“N 147 FASE 1: Corrige estructura de quizzes para eliminaciÃ³n de pre-resoluciÃ³n
// MISIÃ“N 146.5 FASE 2: Genera lecciones con persistencia en Supabase
// MISIÃ“N 147.6 COMPLETADA: Sistema de Prompts Contextuales - Meta-Prompts especializados por contexto pedagÃ³gico
// MISIÃ“N 147.9 COMPLETADA: ReparaciÃ³n del Motor de Contexto Curricular
// MISIÃ“N 147.12 COMPLETADA: Protocolo de Refuerzo de Directivas - Reglas No Negociables implementadas
// MISIÃ“N 147.13 COMPLETADA: CorrecciÃ³n de Sintaxis en Meta-Prompts - Template Literals corregidos
// MISIÃ“N 147.14 COMPLETADA: ReparaciÃ³n de la LÃ³gica de Reemplazo de Plantillas - Reemplazo global implementado
// ğŸš€ MISIÃ“N 154 COMPLETADA: INTEGRACIÃ“N DEL NÃšCLEO RAG - Motor RAG completamente integrado
//   âœ… retrieve_sources() integrado como primera operaciÃ³n del endpoint
//   âœ… Prompt Augmentation con contexto curricular completo y autoritativo
//   âœ… Reemplazo completo de lÃ³gica heredada curriculumMap por Motor RAG
//   âœ… Meta-prompts enriquecidos con informaciÃ³n curricular detallada
//   âœ… Logging RAG especÃ­fico para observabilidad completa
//   âœ… Retrocompatibilidad preservada para casos sin parÃ¡metros de contexto
// ğŸš€ MISIÃ“N 166 COMPLETADA: INTEGRACIÃ“N ARM EXTERNO - ARM completamente funcional
//   âœ… ARM (MÃ³dulo de RecuperaciÃ³n Activa) integrado con Motor RAG
//   âœ… Cache Hit/Cache Miss â†’ Recuperador â†’ Extractor â†’ CachÃ© implementado
//   âœ… Fuentes externas oficiales (URLs) enriquecen contexto curricular
//   âœ… Meta-prompts ARM-Enhanced con contenido de URLs oficiales
//   âœ… Tabla source_content_cache para persistencia de contenido externo
//   âœ… Fallback resiliente: ARM falla â†’ contexto bÃ¡sico RAG se mantiene

import { withOptionalAuth } from '../../utils/authMiddleware';
import { getAuthenticatedSupabaseFromRequest } from '../../lib/supabaseServerAuth.js';
// ğŸš€ MISIÃ“N 154: INTEGRACIÃ“N MOTOR RAG
import { retrieve_sources } from '../../lib/rag/retrieve-sources.js';
// ğŸš€ MISIÃ“N 167 COMPLETADA: CORRECCIÃ“N CRÃTICA META-PROMPTS RAG
//   âœ… Meta-prompts simplificados para garantizar JSON vÃ¡lido
//   âœ… Instrucciones directas y claras para Gemini
//   âœ… Formato de salida explÃ­cito y consistente
//   âœ… CorrecciÃ³n de problema: 0 ejercicios generados en contexto RAG
//   âœ… OptimizaciÃ³n de tiempos de respuesta
//   âœ… VersiÃ³n: Meta-Prompts RAG v3.0 (Corregidos Post-Testing)


// ğŸš€ MISIÃ“N 177: FUNCIÃ“N DE EXTRACCIÃ“N DE CONTEXTO GRANULAR FEDERADO
// Extrae el contexto especÃ­fico del pomodoro usando arquitectura federada v8.1.0
const extraerContextoPomodoro = async (semanaId, dia, pomodoroIndex) => {
  console.log(`ğŸ” [CONTEXTO GRANULAR FEDERADO] Extrayendo contexto para semana ${semanaId}, dÃ­a ${dia}, pomodoro ${pomodoroIndex}`);
  
  try {
    // MISIÃ“N 177: Importar router federado
    const { getWeekDataFederated } = require('../../lib/federated/federated-router.js');
    
    // Obtener datos de la semana usando sistema federado
    console.log(`ğŸš€ [FEDERADO] Cargando datos de semana ${semanaId} desde sistema federado...`);
    const semanaEncontrada = await getWeekDataFederated(semanaId);
    
    // MISIÃ“N 177: NavegaciÃ³n directa usando sistema federado
    // El router federado ya maneja la navegaciÃ³n fase â†’ mÃ³dulo â†’ semana internamente
    
    if (!semanaEncontrada) {
      throw new Error(`Semana ${semanaId} no encontrada en sistema federado`);
    }
    
    console.log(`âœ… [FEDERADO] Semana ${semanaId} cargada desde ${semanaEncontrada.sourceFile}`);
    console.log(`   ğŸ“š TÃ­tulo: "${semanaEncontrada.tituloSemana}"`);
    console.log(`   ğŸ‡ Fase: ${semanaEncontrada.fase} - ${semanaEncontrada.tituloFase}`);
    
    // Validar que existe esquemaDiario
    if (!semanaEncontrada.esquemaDiario || !Array.isArray(semanaEncontrada.esquemaDiario)) {
      throw new Error(`esquemaDiario no disponible para semana ${semanaId}`);
    }
    
    // Encontrar el dÃ­a especÃ­fico (dia es 1-based, array es 0-based)
    const diaData = semanaEncontrada.esquemaDiario[dia - 1];
    if (!diaData) {
      throw new Error(`DÃ­a ${dia} no encontrado en semana ${semanaId}`);
    }
    
    // Validar que existe el pomodoro especÃ­fico
    if (!diaData.pomodoros || !Array.isArray(diaData.pomodoros)) {
      throw new Error(`Pomodoros no disponibles para dÃ­a ${dia} de semana ${semanaId}`);
    }
    
    if (pomodoroIndex < 0 || pomodoroIndex >= diaData.pomodoros.length) {
      throw new Error(`pomodoroIndex ${pomodoroIndex} fuera de rango para dÃ­a ${dia} de semana ${semanaId}`);
    }
    
    const textoPomodoro = diaData.pomodoros[pomodoroIndex];
    
    // Construir objeto de contexto segÃºn especificaciÃ³n de la misiÃ³n
    const contexto = {
      tematica_semanal: semanaEncontrada.tituloSemana,
      concepto_del_dia: diaData.concepto,
      texto_del_pomodoro: textoPomodoro
    };
    
    console.log(`âœ… [CONTEXTO GRANULAR FEDERADO] ExtraÃ­do exitosamente:`);
    console.log(`   ğŸ“š TemÃ¡tica: "${contexto.tematica_semanal}"`);
    console.log(`   ğŸ¯ Concepto: "${contexto.concepto_del_dia}"`);
    console.log(`   ğŸ“ Pomodoro: "${contexto.texto_del_pomodoro}"`);
    console.log(`   ğŸ“‚ Fuente: ${semanaEncontrada.sourceFile} (Arquitectura Federada v8.1.0)`);
    
    return contexto;
    
  } catch (error) {
    console.error(`âŒ [ERROR CONTEXTO GRANULAR FEDERADO] Error extrayendo contexto:`, error.message);
    throw error;
  }
};

// MISIÃ“N 154: FUNCIÃ“N DEPRECADA - Reemplazada por Motor RAG retrieve_sources()
// Mantenida solo para retrocompatibilidad en casos sin parÃ¡metros de contexto
const getCurriculumInfoLegacy = (semanaId) => {
  console.warn(`âš ï¸ [LEGACY] Usando curriculumMap estÃ¡tico para semana ${semanaId} (sin contexto RAG)`);
  
  // Mapeo bÃ¡sico heredado - Solo para fallback
  const curriculumMap = {
    1: { tema: "TeorÃ­a y Ã‰tica de IA", fase: "Fase 0: CimentaciÃ³n del Arquitecto" },
    2: { tema: "PrÃ¡ctica de DiseÃ±o de Prompts", fase: "Fase 0: CimentaciÃ³n del Arquitecto" },
    3: { tema: "CS50 - Semana 0: IntroducciÃ³n", fase: "Fase 0: CimentaciÃ³n del Arquitecto" },
    25: { tema: "ProgramaciÃ³n Orientada a Objetos - Conceptos Fundamentales", fase: "Fase 1: Fundamentos de ProgramaciÃ³n" },
    50: { tema: "Fundamentos de Node.js - ProfundizaciÃ³n", fase: "Fase 3: Desarrollo Backend Profesional" },
    75: { tema: "Fundamentos de Cloud Computing (AWS/GCP)", fase: "Fase 4: DevOps y Cloud Computing" },
    100: { tema: "ContribuciÃ³n Open Source y Crecimiento Continuo", fase: "Fase 7: ProfesionalizaciÃ³n y Crecimiento Continuo" },
    default: { tema: "Desarrollo de Software", fase: "Ecosistema 360" }
  };

  return curriculumMap[semanaId] || curriculumMap.default;
};

// MISIÃ“N 154 + 166: FUNCIÃ“N RAG + ARM EXTERNO - Obtiene contexto curricular con fuentes externas
const getCurriculumInfoRAG = async (semanaId) => {
  try {
    console.log(`ğŸ” [RAG+ARM] Recuperando contexto curricular con fuentes externas para semana ${semanaId}...`);
    
    // PRIMERA OPERACIÃ“N: Invocar Motor RAG + ARM Externo (includeExternalSources = true)
    const ragContext = await retrieve_sources(semanaId, true);
    
    console.log(`âœ… [RAG+ARM] Contexto recuperado exitosamente:`);
    console.log(`   ğŸ“š TÃ­tulo: "${ragContext.weekTitle}"`);
    console.log(`   ğŸ¯ Fase: ${ragContext.phase} - ${ragContext.phaseTitle}`);
    console.log(`   ğŸ“˜ MÃ³dulo: ${ragContext.module} - ${ragContext.moduleTitle}`);
    console.log(`   ğŸ·ï¸ Enfoque PedagÃ³gico: ${ragContext.pedagogicalApproach}`);
    console.log(`   ğŸ“Š Nivel Dificultad: ${ragContext.difficultyLevel}`);
    console.log(`   ğŸ“‹ Objetivos: ${ragContext.objectives.length}`);
    console.log(`   ğŸ“¦ Recursos: ${ragContext.resources.length}`);
    console.log(`   ğŸ“ Prerequisitos: ${ragContext.prerequisites.length}`);
    
    // MISIÃ“N 166: Logging ARM especÃ­fico
    if (ragContext.armStatus === 'enriched' && ragContext.externalSources?.length > 0) {
      console.log(`   ğŸŒ [ARM] Fuentes externas: ${ragContext.externalSources.length} procesadas`);
      console.log(`   âš¡ [ARM] Cache hits: ${ragContext.armMetadata.cacheHits}/${ragContext.armMetadata.totalUrls}`);
      console.log(`   ğŸ• [ARM] Tiempo total: ${ragContext.armMetadata.totalProcessTimeMs}ms`);
      
      ragContext.externalSources.forEach((source, index) => {
        console.log(`      ${index + 1}. ${source.type}: ${source.name} (${source.fromCache ? 'cached' : 'fresh'})`);
      });
    } else if (ragContext.armStatus === 'no-external-sources') {
      console.log(`   â„¹ï¸ [ARM] No hay fuentes externas para esta semana`);
    } else if (ragContext.armStatus === 'error') {
      console.warn(`   âš ï¸ [ARM] Error procesando fuentes externas: ${ragContext.armError}`);
    }
    
    // Devolver formato compatible con funciÃ³n legacy
    return {
      tema: ragContext.weekTitle,
      fase: `Fase ${ragContext.phase}: ${ragContext.phaseTitle.replace(/^Fase \d+: /, '')}`,
      // Contexto RAG enriquecido adicional
      ragContext: ragContext
    };
    
  } catch (error) {
    console.error(`âŒ [RAG ERROR] Error recuperando contexto para semana ${semanaId}:`, error.message);
    
    // Fallback a funciÃ³n legacy en caso de error RAG
    console.warn(`ğŸ”„ [FALLBACK] Usando curriculumMap legacy para semana ${semanaId}`);
    return getCurriculumInfoLegacy(semanaId);
  }
};

// FunciÃ³n para obtener propÃ³sito del pomodoro segÃºn su Ã­ndice
const getPomodoroContext = (pomodoroIndex) => {
  // Mapeo basado en la estructura del WeeklySchedule
  const pomodoroContextMap = {
    0: {
      tipo: "teorico",
      proposito: "Estudio del concepto teÃ³rico del dÃ­a - AdquisiciÃ³n de conocimiento fundamental"
    },
    1: {
      tipo: "teorico", 
      proposito: "PrÃ¡ctica guiada y experimentaciÃ³n con el cÃ³digo - ConsolidaciÃ³n teÃ³rica"
    },
    2: {
      tipo: "evaluativo",
      proposito: "ResoluciÃ³n de ejercicios nuevos - AplicaciÃ³n prÃ¡ctica de conocimientos"
    },
    3: {
      tipo: "evaluativo",
      proposito: "ContinuaciÃ³n de problemas y revisiÃ³n - IntegraciÃ³n y evaluaciÃ³n"
    }
  };

  return pomodoroContextMap[pomodoroIndex] || pomodoroContextMap[0];
};

// ğŸš€ MISIÃ“N 171.2: TEMPLATE DE PROMPT UNIVERSAL GRANULAR
// Template Ãºnico que usa contexto especÃ­fico del pomodoro en lugar de tema genÃ©rico de semana
const TEMPLATE_PROMPT_UNIVERSAL = `
Eres un tutor de programaciÃ³n experto y un pedagogo excepcional, especializado en el tema de: "{tematica_semanal}".

Tu misiÃ³n es crear una micro-lecciÃ³n y un quiz para un estudiante autodidacta. La lecciÃ³n debe ser clara, concisa y enfocada en un solo punto.

El concepto general del dÃ­a es: "{concepto_del_dia}".
La tarea especÃ­fica a enseÃ±ar en esta micro-lecciÃ³n es: "{texto_del_pomodoro}".

Basado ESTRICTA y EXCLUSIVAMENTE en la tarea especÃ­fica, genera lo siguiente en formato JSON:
{
  "contenido": "Un texto de lecciÃ³n claro y conciso que explique CÃ“MO realizar la tarea mencionada. Si la tarea implica cÃ³digo, provee ejemplos cortos y prÃ¡cticos. No te desvÃ­es a otros temas.",
  "quiz": [
    {
      "pregunta": "Una pregunta que evalÃºe la comprensiÃ³n especÃ­fica de la tarea del pomodoro.",
      "opciones": ["OpciÃ³n A", "OpciÃ³n B", "OpciÃ³n C", "OpciÃ³n D"],
      "respuesta_correcta": "La opciÃ³n correcta"
    }
  ]
}
`;

// DEPRECATED: META-PROMPT TEÃ“RICO RAG-ENHANCED v2.0 - Reemplazado por Template Universal
// Mantenido solo para referencia histÃ³rica
const META_PROMPT_TEORICO_RAG_DEPRECATED = `
Eres un mentor experto del "Ecosistema 360" creando contenido educativo.

**CONTEXTO CURRICULAR:**
- Semana {SEMANA_ID}: {TEMA_DE_LA_SEMANA}
- Fase: {FASE_CURRICULAR} 
- Enfoque: {ENFOQUE_PEDAGOGICO}
- Nivel: {NIVEL_DIFICULTAD}

**REGLA ABSOLUTA:** Todo el contenido debe relacionarse EXCLUSIVAMENTE con "{TEMA_DE_LA_SEMANA}"

**TAREA:** Genera un objeto JSON vÃ¡lido con esta estructura exacta:

{
  "title": "TÃ­tulo especÃ­fico sobre {TEMA_DE_LA_SEMANA}",
  "lesson": "Contenido educativo de 300-500 palabras sobre {TEMA_DE_LA_SEMANA}",
  "exercises": [
    {
      "question": "Pregunta sobre {TEMA_DE_LA_SEMANA}",
      "type": "multiple_choice", 
      "options": ["OpciÃ³n A", "OpciÃ³n B", "OpciÃ³n C", "OpciÃ³n D"],
      "correctAnswerIndex": 0,
      "explanation": "ExplicaciÃ³n de la respuesta correcta"
    },
    {
      "question": "Segunda pregunta sobre {TEMA_DE_LA_SEMANA}",
      "type": "multiple_choice",
      "options": ["OpciÃ³n A", "OpciÃ³n B", "OpciÃ³n C", "OpciÃ³n D"], 
      "correctAnswerIndex": 1,
      "explanation": "ExplicaciÃ³n de la respuesta correcta"
    },
    {
      "question": "Tercera pregunta sobre {TEMA_DE_LA_SEMANA}",
      "type": "multiple_choice",
      "options": ["OpciÃ³n A", "OpciÃ³n B", "OpciÃ³n C", "OpciÃ³n D"],
      "correctAnswerIndex": 2, 
      "explanation": "ExplicaciÃ³n de la respuesta correcta"
    }
  ]
}

**IMPORTANTE:** 
- Responde SOLO con el JSON vÃ¡lido
- correctAnswerIndex debe ser nÃºmero entero (0, 1, 2, o 3)
- Cada ejercicio debe evaluar {TEMA_DE_LA_SEMANA}
- NO agregues texto antes o despuÃ©s del JSON
`;

// DEPRECATED: META-PROMPT EVALUATIVO RAG-ENHANCED v2.0 - Reemplazado por Template Universal
// Mantenido solo para referencia histÃ³rica
const META_PROMPT_EVALUATIVO_RAG_DEPRECATED = `
Eres un evaluador experto del "Ecosistema 360" creando ejercicios de evaluaciÃ³n.

**CONTEXTO CURRICULAR:**
- Semana {SEMANA_ID}: {TEMA_DE_LA_SEMANA}
- Fase: {FASE_CURRICULAR}
- Enfoque: {ENFOQUE_PEDAGOGICO} 
- Nivel: {NIVEL_DIFICULTAD}

**REGLA ABSOLUTA:** Todo el contenido debe relacionarse EXCLUSIVAMENTE con "{TEMA_DE_LA_SEMANA}"

**TAREA:** Genera un objeto JSON vÃ¡lido con esta estructura exacta:

{
  "title": "EvaluaciÃ³n: {TEMA_DE_LA_SEMANA}",
  "lesson": "IntroducciÃ³n breve a los ejercicios de evaluaciÃ³n sobre {TEMA_DE_LA_SEMANA}",
  "exercises": [
    {
      "question": "Pregunta de 'Recordar' sobre {TEMA_DE_LA_SEMANA}",
      "type": "multiple_choice",
      "options": ["OpciÃ³n A", "OpciÃ³n B", "OpciÃ³n C", "OpciÃ³n D"],
      "correctAnswerIndex": 0,
      "explanation": "ExplicaciÃ³n de por quÃ© esta respuesta es correcta"
    },
    {
      "question": "Pregunta de 'Comprender' sobre {TEMA_DE_LA_SEMANA}", 
      "type": "multiple_choice",
      "options": ["OpciÃ³n A", "OpciÃ³n B", "OpciÃ³n C", "OpciÃ³n D"],
      "correctAnswerIndex": 1,
      "explanation": "ExplicaciÃ³n de por quÃ© esta respuesta es correcta"
    },
    {
      "question": "Pregunta de 'Aplicar' sobre {TEMA_DE_LA_SEMANA}",
      "type": "multiple_choice", 
      "options": ["OpciÃ³n A", "OpciÃ³n B", "OpciÃ³n C", "OpciÃ³n D"],
      "correctAnswerIndex": 2,
      "explanation": "ExplicaciÃ³n de por quÃ© esta respuesta es correcta"
    }
  ]
}

**IMPORTANTE:**
- Responde SOLO con el JSON vÃ¡lido
- correctAnswerIndex debe ser nÃºmero entero (0, 1, 2, o 3)  
- Ejercicios deben seguir TaxonomÃ­a de Bloom
- NO agregues texto antes o despuÃ©s del JSON
`;

// ğŸš€ MISIÃ“N 177: FUNCIÃ“N PRINCIPAL CON CONTEXTO GRANULAR FEDERADO
// Genera prompt usando contexto especÃ­fico del pomodoro desde arquitectura federada v8.1.0
const generateContextualPromptGranular = async (semanaId, dia, pomodoroIndex) => {
  console.log(`ğŸš€ [PROMPT GRANULAR FEDERADO] Generando prompt para semana ${semanaId}, dÃ­a ${dia}, pomodoro ${pomodoroIndex} usando arquitectura federada`);
  
  try {
    // PASO 1: Extraer contexto especÃ­fico del pomodoro usando sistema federado
    const contextoPomodoro = await extraerContextoPomodoro(semanaId, dia, pomodoroIndex);
    
    // PASO 2: Poblar template universal con contexto granular
    const promptGenerado = TEMPLATE_PROMPT_UNIVERSAL
      .replace(/{tematica_semanal}/g, contextoPomodoro.tematica_semanal)
      .replace(/{concepto_del_dia}/g, contextoPomodoro.concepto_del_dia)
      .replace(/{texto_del_pomodoro}/g, contextoPomodoro.texto_del_pomodoro);
    
    console.log(`âœ… [PROMPT GRANULAR FEDERADO] Template poblado exitosamente:`);
    console.log(`   ğŸ“š TemÃ¡tica: "${contextoPomodoro.tematica_semanal}"`);
    console.log(`   ğŸ¯ Concepto: "${contextoPomodoro.concepto_del_dia}"`);
    console.log(`   ğŸ“ Tarea: "${contextoPomodoro.texto_del_pomodoro}"`);
    console.log(`   ğŸš€ Arquitectura: Sistema Federado v8.1.0`);
    
    return promptGenerado;
    
  } catch (error) {
    console.error(`âŒ [ERROR PROMPT GRANULAR FEDERADO] Error generando prompt granular con arquitectura federada:`, error.message);
    
    // Fallback a funciÃ³n RAG original
    console.warn(`ğŸ”„ [FALLBACK] Usando generateContextualPromptRAGLegacy por error en sistema federado`);
    return generateContextualPromptRAGLegacy(semanaId, pomodoroIndex, '');
  }
};

// DEPRECATED: FUNCIÃ“N PRINCIPAL RAG-ENHANCED - Reemplazada por contexto granular
// Mantenida para retrocompatibilidad y casos de fallback
const generateContextualPromptRAGLegacy = async (semanaId, pomodoroIndex, inputText) => {
  console.log(`ğŸš€ [RAG PROMPT LEGACY] Generando prompt contextual para semana ${semanaId}, pomodoro ${pomodoroIndex}`);
  
  try {
    // PASO 1: Obtener contexto curricular completo del Motor RAG
    const curriculumInfo = await getCurriculumInfoRAG(semanaId);
    const pomodoroContext = getPomodoroContext(pomodoroIndex);
    
    // PASO 2: Seleccionar plantilla RAG-Enhanced segÃºn pomodoroIndex
    let selectedPrompt;
    if (pomodoroIndex === 0 || pomodoroIndex === 1) {
      selectedPrompt = META_PROMPT_TEORICO_RAG_DEPRECATED;
      console.log(`ğŸ¯ [RAG LEGACY] Prompt seleccionado: META_PROMPT_TEORICO_RAG para pomodoro ${pomodoroIndex}`);
    } else if (pomodoroIndex === 2 || pomodoroIndex === 3) {
      selectedPrompt = META_PROMPT_EVALUATIVO_RAG_DEPRECATED;
      console.log(`ğŸ¯ [RAG LEGACY] Prompt seleccionado: META_PROMPT_EVALUATIVO_RAG para pomodoro ${pomodoroIndex}`);
    } else {
      selectedPrompt = META_PROMPT_TEORICO_RAG_DEPRECATED;
      console.warn(`âš ï¸ [RAG LEGACY] pomodoroIndex ${pomodoroIndex} fuera de rango, usando META_PROMPT_TEORICO_RAG por defecto`);
    }
    
    // PASO 3: Construir contexto enriquecido si tenemos informaciÃ³n RAG
    let enrichedPrompt;
    if (curriculumInfo.ragContext) {
      const ragCtx = curriculumInfo.ragContext;
      
      // Poblar plantilla RAG + ARM con contexto completo (reemplazo global)
      enrichedPrompt = selectedPrompt
        .replace(/{SEMANA_ID}/g, semanaId.toString())
        .replace(/{TEMA_DE_LA_SEMANA}/g, ragCtx.weekTitle)
        .replace(/{FASE_CURRICULAR}/g, `Fase ${ragCtx.phase}: ${ragCtx.phaseTitle}`)
        .replace(/{MODULO_TITULO}/g, `MÃ³dulo ${ragCtx.module}: ${ragCtx.moduleTitle}`)
        .replace(/{ENFOQUE_PEDAGOGICO}/g, ragCtx.pedagogicalApproach)
        .replace(/{NIVEL_DIFICULTAD}/g, ragCtx.difficultyLevel);
        
      console.log(`âœ… [RAG LEGACY] Prompt enriquecido con contexto curricular`);
      
    } else {
      // Fallback: usar informaciÃ³n bÃ¡sica del curriculum legacy
      console.warn(`âš ï¸ [RAG LEGACY FALLBACK] Sin contexto RAG, usando informaciÃ³n bÃ¡sica`);
      enrichedPrompt = selectedPrompt
        .replace(/{SEMANA_ID}/g, semanaId.toString())
        .replace(/{TEMA_DE_LA_SEMANA}/g, curriculumInfo.tema)
        .replace(/{FASE_CURRICULAR}/g, curriculumInfo.fase);
    }
    
    return enrichedPrompt;
    
  } catch (error) {
    console.error(`âŒ [RAG LEGACY ERROR] Error generando prompt contextual:`, error.message);
    
    // Fallback completo: usar funciÃ³n legacy original
    console.warn(`ğŸ”„ [COMPLETE FALLBACK] Usando generateContextualPromptLegacy`);
    return generateContextualPromptLegacy(semanaId, pomodoroIndex, inputText);
  }
};

// FUNCIÃ“N LEGACY PRESERVADA para casos de fallback completo
const generateContextualPromptLegacy = (semanaId, pomodoroIndex, inputText) => {
  console.warn(`âš ï¸ [LEGACY PROMPT] Generando prompt con curriculumMap estÃ¡tico`);
  
  const curriculumInfo = getCurriculumInfoLegacy(semanaId);
  const pomodoroContext = getPomodoroContext(pomodoroIndex);
  
  // Meta-prompts originales (versiones bÃ¡sicas)
  const META_PROMPT_TEORICO_BASIC = `
ActÃºa como un mentor y arquitecto de sistemas senior del "Ecosistema 360".
Tu tarea es generar el contenido para un micro-mÃ³dulo de estudio.

Tema Principal de la Semana: {TEMA_DE_LA_SEMANA}
Objetivo EspecÃ­fico de este Bloque: {PROPOSITO_DEL_POMODORO}

1. Genera el "Contenido de la LecciÃ³n":
- Profundidad: 500-700 palabras para 45 minutos de estudio.
- Estructura: SubtÃ­tulos claros + explicaciones conceptuales.
- Componentes: 2+ ejemplos prÃ¡cticos + analogÃ­a obligatoria.

2. Genera los "Ejercicios de PrÃ¡ctica":
Quiz de 3 preguntas de opciÃ³n mÃºltiple para evaluaciÃ³n.

Formato: content.lesson y content.quiz en JSON estructurado.
`;

  const META_PROMPT_EVALUATIVO_BASIC = `
ActÃºa como un examinador que diseÃ±a evaluaciones para validar comprensiÃ³n del "Ecosistema 360".

Tema Principal de la Semana: {TEMA_DE_LA_SEMANA}
Objetivo EspecÃ­fico de este Bloque: {PROPOSITO_DEL_POMODORO}

Genera quiz de 3 preguntas con TaxonomÃ­a de Bloom:
1. Pregunta de 'Recordar'
2. Pregunta de 'Comprender'  
3. Pregunta de 'Aplicar/Analizar' con escenario

Formato: content.quiz y content.lesson (introducciÃ³n breve) en JSON.
`;

  let selectedPrompt = pomodoroIndex === 0 || pomodoroIndex === 1 
    ? META_PROMPT_TEORICO_BASIC 
    : META_PROMPT_EVALUATIVO_BASIC;
  
  return selectedPrompt
    .replace(/{TEMA_DE_LA_SEMANA}/g, curriculumInfo.tema)
    .replace(/{PROPOSITO_DEL_POMODORO}/g, pomodoroContext.proposito);
};

// ğŸš€ MISIÃ“N 171.2: FunciÃ³n de validaciÃ³n para estructura granular y fallbacks
const validateExerciseStructure = (exercise) => {
  return exercise && 
         typeof exercise === 'object' && 
         exercise.question && 
         exercise.type === 'multiple_choice' && 
         Array.isArray(exercise.options) && 
         exercise.options.length === 4 &&
         typeof exercise.correctAnswerIndex === 'number' &&
         exercise.correctAnswerIndex >= 0 &&
         exercise.correctAnswerIndex <= 3;
  // explanation es opcional para compatibilidad
};

// Handler principal
async function handler(req, res) {
  // Verificar mÃ©todo HTTP
  if (req.method !== 'POST') {
    return res.status(405).json({ 
      error: 'MÃ©todo no permitido',
      message: 'Este endpoint solo acepta solicitudes POST' 
    });
  }

  try {
    // ğŸš€ MISIÃ“N 177: VALIDACIÃ“N DE PARÃMETROS GRANULARES - CORREGIDA
    // Endpoint refactorizado para aceptar tanto dia como diaIndex para compatibilidad
    const { semanaId, dia, diaIndex, pomodoroIndex } = req.body;

    // COMPATIBILIDAD: Aceptar tanto 'dia' como 'diaIndex' del frontend
    const diaFinal = dia || (diaIndex !== undefined ? diaIndex + 1 : null);

    // VALIDACIÃ“N: ParÃ¡metros granulares obligatorios
    if (!semanaId || !diaFinal || pomodoroIndex === undefined) {
      return res.status(400).json({
        error: 'ParÃ¡metros granulares requeridos',
        message: 'Los campos semanaId, dia/diaIndex y pomodoroIndex son obligatorios para generaciÃ³n granular',
        received: { semanaId, dia, diaIndex, pomodoroIndex, diaFinal }
      });
    }

    // ValidaciÃ³n de tipos y rangos
    if (!Number.isInteger(semanaId) || semanaId < 1) {
      return res.status(400).json({
        error: 'semanaId invÃ¡lido',
        message: 'semanaId debe ser un entero positivo'
      });
    }

    if (!Number.isInteger(diaFinal) || diaFinal < 1 || diaFinal > 5) {
      return res.status(400).json({
        error: 'dia invÃ¡lido', 
        message: 'dia debe ser un entero entre 1 y 5'
      });
    }

    if (!Number.isInteger(pomodoroIndex) || pomodoroIndex < 0 || pomodoroIndex > 3) {
      return res.status(400).json({
        error: 'pomodoroIndex invÃ¡lido',
        message: 'pomodoroIndex debe ser un entero entre 0 y 3'
      });
    }

    // Verificar API key de Gemini
    const apiKey = process.env.GEMINI_API_KEY;
    if (!apiKey) {
      console.error('âŒ API key de Gemini no configurada');
      return res.status(500).json({ 
        error: 'ConfiguraciÃ³n del servidor',
        message: 'API de IA no configurada correctamente' 
      });
    }

    const { isAuthenticated, userId } = req.authContext;

    console.log(`ğŸ§ª [GENERACIÃ“N GRANULAR FEDERADA] Generando lecciÃ³n para semana ${semanaId}, dÃ­a ${diaFinal}, pomodoro ${pomodoroIndex} usando arquitectura federada v8.1.0`);

    // ğŸš€ MISIÃ“N 177: USAR FUNCIÃ“N GRANULAR FEDERADA COMO RUTA PRINCIPAL
    console.log(`ğŸš€ [CONTEXTO GRANULAR FEDERADO] Iniciando generaciÃ³n con contexto especÃ­fico del pomodoro usando arquitectura federada...`);
    const prompt = await generateContextualPromptGranular(semanaId, diaFinal, pomodoroIndex);
    console.log(`âœ… [GRANULAR FEDERADO] Usando prompt contextual granular con datos federados`);

    // ğŸš¨ MISIÃ“N 171.2: LOGGING DEBUG GRANULAR - Mostrar prompt granular antes de envÃ­o
    console.log(`\nğŸ” [DEBUG CONTEXTO GRANULAR] PROMPT GRANULAR A ENVIAR A GEMINI:`);
    console.log(`================== INICIO PROMPT GRANULAR ==================`);
    console.log(prompt);
    console.log(`================== FIN PROMPT GRANULAR ===================\n`);
    
    // Verificar que las variables granulares se reemplazaron correctamente
    if (prompt.includes('{')) {
      const unreplacedVars = prompt.match(/{[a-z_]+}/g);
      if (unreplacedVars) {
        console.error(`âŒ [GRANULAR ERROR CRÃTICO] Variables granulares no reemplazadas:`, unreplacedVars);
      } else {
        console.log(`âœ… [GRANULAR] Todas las variables contextuales reemplazadas exitosamente`);
      }
    }

    // Llamar a la API de Gemini con prompt granular
    const response = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=${apiKey}`, {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json'
      },
      body: JSON.stringify({
        contents: [{
          parts: [{ text: prompt }]
        }],
        generationConfig: {
          maxOutputTokens: 1500,
          temperature: 0.4,
          candidateCount: 1
        }
      })
    });

    // Verificar respuesta de Gemini
    if (!response.ok) {
      console.error(`âŒ Error de Gemini API: ${response.status} ${response.statusText}`);
      return res.status(500).json({ 
        error: 'Error del servicio de IA',
        message: `La API de IA respondiÃ³ con estado ${response.status}` 
      });
    }

    const geminiData = await response.json();

    // Verificar estructura de respuesta
    if (!geminiData.candidates || !geminiData.candidates[0] || !geminiData.candidates[0].content) {
      console.error('âŒ Respuesta inesperada de Gemini:', geminiData);
      return res.status(500).json({ 
        error: 'Respuesta invÃ¡lida de IA',
        message: 'El servicio de IA no devolviÃ³ el formato esperado' 
      });
    }

    const generatedText = geminiData.candidates[0].content.parts[0].text;

    // Intentar parsear JSON de la respuesta
    let lessonData;
    try {
      // Limpiar la respuesta para extraer solo el JSON
      const jsonMatch = generatedText.match(/\{[\s\S]*\}/);
      if (jsonMatch) {
        lessonData = JSON.parse(jsonMatch[0]);
      } else {
        // Si no hay JSON vÃ¡lido, crear estructura bÃ¡sica
        lessonData = {
          title: "LecciÃ³n Generada",
          lesson: generatedText,
          exercises: []
        };
      }
    } catch (parseError) {
      console.warn('âš ï¸ No se pudo parsear JSON de Gemini, usando texto plano:', parseError.message);
      // Fallback: crear estructura con el texto generado
      lessonData = {
        title: "LecciÃ³n Generada",
        lesson: generatedText,
        exercises: []
      };
    }

    // ğŸš€ MISIÃ“N 171.2: Procesamiento para formato granular y fallbacks
    let extractedLesson, extractedExercises;
    
    if (lessonData.contenido && lessonData.quiz) {
      // Formato granular: contenido y quiz
      extractedLesson = lessonData.contenido;
      extractedExercises = lessonData.quiz.map(q => ({
        question: q.pregunta,
        type: 'multiple_choice',
        options: q.opciones,
        // Encontrar Ã­ndice de la respuesta correcta
        correctAnswerIndex: q.opciones.findIndex(opcion => opcion === q.respuesta_correcta),
        explanation: `La respuesta correcta es: ${q.respuesta_correcta}`
      }));
      console.log('âœ¨ [GRANULAR] Procesando respuesta con formato granular contenido/quiz');
    } else if (lessonData.content) {
      // Formato RAG: content.lesson y content.quiz
      extractedLesson = lessonData.content.lesson || lessonData.lesson || generatedText;
      extractedExercises = lessonData.content.quiz || lessonData.exercises || [];
      console.log('âœ¨ [RAG FALLBACK] Procesando respuesta con formato content.lesson/content.quiz');
    } else {
      // Formato legacy: lesson y exercises
      extractedLesson = lessonData.lesson || generatedText;
      extractedExercises = lessonData.exercises || [];
      console.log('ğŸ”„ [LEGACY FALLBACK] Procesando respuesta con formato legacy lesson/exercises');
    }

    // ğŸš€ MISIÃ“N 177: Construir respuesta enriquecida con contexto granular federado
    const cleanedLesson = {
      title: lessonData.title || "Micro-LecciÃ³n Granular Federada",
      lesson: extractedLesson,
      exercises: Array.isArray(extractedExercises) ? 
        extractedExercises.filter(ex => {
          // Usar funciÃ³n de validaciÃ³n
          const isValid = validateExerciseStructure(ex);
          if (!isValid) {
            console.warn('âš ï¸ Ejercicio descartado por estructura incorrecta:', {
              hasQuestion: !!ex?.question,
              hasType: ex?.type === 'multiple_choice',
              hasOptions: Array.isArray(ex?.options) && ex?.options?.length === 4,
              hasCorrectAnswerIndex: typeof ex?.correctAnswerIndex === 'number',
              correctAnswerIndexInRange: ex?.correctAnswerIndex >= 0 && ex?.correctAnswerIndex <= 3,
              hasExplanation: !!ex?.explanation
            });
          }
          return isValid;
        }).map(ex => ({
          ...ex,
          type: 'multiple_choice' // Asegurar que siempre tenga el tipo correcto
        })) : [],
      generatedAt: new Date().toISOString(),
      inputLength: 0, // Campo legacy mantenido para compatibilidad
      // ğŸš€ MISIÃ“N 177: Metadatos granulares federados enriquecidos
      semanaId,
      dia: diaFinal, 
      pomodoroIndex,
      contextInfo: {
        promptType: 'granular_federated',
        granularEnabled: true,
        granularVersion: 'v2.0_federated',
        federatedArchitecture: 'v8.1.0',
        dataSource: 'federated_system'
      }
    };

    // Log de validaciÃ³n de ejercicios
    if (extractedExercises && extractedExercises.length > 0) {
      const originalCount = extractedExercises.length;
      const validCount = cleanedLesson.exercises.length;
      console.log(`ğŸ“Š [RAG] ValidaciÃ³n ejercicios: ${validCount}/${originalCount} vÃ¡lidos con correctAnswerIndex`);
      
      // Log detallado de ejercicios vÃ¡lidos
      cleanedLesson.exercises.forEach((ex, index) => {
        console.log(`âœ… Ejercicio ${index + 1}: correctAnswerIndex=${ex.correctAnswerIndex} â†’ "${ex.options[ex.correctAnswerIndex]}"`);
      });
    }

    // ğŸ’¾ MISIÃ“N 171.2: PERSISTIR SIEMPRE (parÃ¡metros granulares obligatorios)
    if (isAuthenticated) {
      try {
        console.log(`ğŸ’¾ [GRANULAR] Persistiendo lecciÃ³n granular para usuario ${userId} en BD...`);
        
        const authenticatedSupabase = getAuthenticatedSupabaseFromRequest(req);
        
        // Insertar en tabla generated_content
        const { data: savedContent, error: saveError } = await authenticatedSupabase
          .from('generated_content')
          .insert({
            user_id: userId,
            semana_id: semanaId,
            dia_index: diaFinal - 1, // Convertir a 0-based para consistencia con BD
            pomodoro_index: pomodoroIndex,
            content: cleanedLesson
          })
          .select()
          .single();

        if (saveError) {
          console.error('âš ï¸ Error guardando en BD (continuando con respuesta):', saveError);
          // No devolver error, solo log - la generaciÃ³n fue exitosa
        } else {
          console.log(`âœ… [GRANULAR] LecciÃ³n granular persistida con ID: ${savedContent.id}`);
          cleanedLesson.savedToDatabase = true;
          cleanedLesson.contentId = savedContent.id;
        }

      } catch (persistError) {
        console.error('âš ï¸ Error en persistencia (continuando con respuesta):', persistError);
        // No devolver error, solo log - la generaciÃ³n fue exitosa
      }
    }

    // ğŸš€ MISIÃ“N 177: Log diferenciado con informaciÃ³n granular federada
    const promptTypeUsed = cleanedLesson.contextInfo?.promptType || 'granular_federated';
    const granularInfo = cleanedLesson.contextInfo?.granularEnabled ? ' (Contexto Granular Federado)' : '';
    const federatedInfo = cleanedLesson.contextInfo?.federatedArchitecture || 'v8.1.0';
    
    console.log(`âœ… [GRANULAR FEDERADO SUCCESS] LecciÃ³n generada con contexto granular federado:`);
    console.log(`   ğŸ¯ Prompt: ${promptTypeUsed}${granularInfo}`);
    console.log(`   ğŸ“š TÃ­tulo: "${cleanedLesson.title}"`);
    console.log(`   ğŸ“ Ejercicios: ${cleanedLesson.exercises.length} interactivos`);
    console.log(`   ğŸ’¾ Persistencia: ${cleanedLesson.savedToDatabase ? 'BD' : 'No'}`);
    console.log(`   ğŸ” Contexto: Semana ${semanaId}, DÃ­a ${diaFinal}, Pomodoro ${pomodoroIndex}`);
    console.log(`   ğŸš€ Arquitectura: Federada ${federatedInfo} (Rendimiento +52%)`);
    console.log(`   ğŸ“‚ Fuente: Sistema federado index.json + fase-N.json`);

    // Respuesta exitosa con contexto granular
    res.status(200).json(cleanedLesson);

  } catch (error) {
    console.error('âŒ [GRANULAR FEDERADO ERROR] Error interno generando lecciÃ³n:', error);
    
    // Determinar tipo de error para respuesta apropiada
    if (error.name === 'TypeError' && error.message.includes('fetch')) {
      return res.status(500).json({ 
        error: 'Error de conectividad',
        message: 'No se pudo conectar con el servicio de IA' 
      });
    }

    res.status(500).json({ 
      error: 'Error interno del servidor',
      message: 'OcurriÃ³ un error inesperado al generar la lecciÃ³n'
    });
  }
}

// Aplicar middleware de autenticaciÃ³n opcional
export default withOptionalAuth(handler);
