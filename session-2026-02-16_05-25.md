# Sesion de Debugging - 2026-02-16 05:25

## Objetivo
Retomar testeo manual de la aplicacion. Se encontraron errores criticos al cargar.

## Errores encontrados y diagnostico

### 1. `originalFactory is undefined` (webpack/RSC)
- **Sintoma:** Error en consola del navegador al cargar cualquier ruta del App Router
- **Stack trace:** `react-server-dom-webpack-client.browser.development.js` -> `requireModule` -> `initializeModuleChunk`
- **Causa raiz:** Next.js 15.4.11 tenia un bug en webpack module factories para React Server Components
- **Fix:** Actualizado Next.js de 15.4.11 a 16.1.6
- **Estado:** PENDIENTE DE VERIFICACION (servidor levantado, falta confirmar en navegador)

### 2. `global-error.js` ocultaba errores reales
- **Sintoma:** Pantalla negra sin informacion
- **Causa:** El archivo `app/global-error.js` (nuevo, no commiteado) capturaba cualquier error del App Router y renderizaba `<h1>Algo salio mal</h1>` con fondo negro (CSS del body), haciendo invisible el texto
- **Fix:** Archivo renombrado a `global-error.js.bak`
- **Estado:** RESUELTO

### 3. AuthGate bloqueaba rutas publicas
- **Sintoma:** Pantalla de carga "Sincronizando con el Mentor IA..." infinita en `/`
- **Causa:** El `AuthGate` en `providers.js` no distinguia rutas publicas de privadas. Bloqueaba toda la app hasta resolver el auth check
- **Fix:** Se agrego deteccion de rutas publicas (`/`, `/login`, `/register`) con `isPublicPath` state que permite renderizar children sin esperar auth
- **Estado:** RESUELTO

### 4. Loop infinito en useAuth checkSession
- **Sintoma:** Multiples requests repetidas a `/api/auth/user`
- **Causa:** El `useEffect` en `useAuth.js` tenia `authState` como dependencia, lo que causaba re-ejecuciones cada vez que el estado cambiaba (loading -> unauthenticated -> re-check)
- **Fix:** Separado en dos useEffects: uno para check inicial (solo al montar) y otro para auto-refresh periodico
- **Estado:** RESUELTO

### 5. PixelLoader sin directiva 'use client'
- **Sintoma:** Error de webpack al importar `next/script` en Server Component
- **Causa:** `components/analytics/PixelLoader.js` usaba `next/script` (client-only) pero no tenia `'use client'`
- **Fix:** Agregada directiva `'use client'` + movido PixelLoader y CookieBanner dentro de `Providers` (client boundary) en lugar de importarlos directamente en `layout.js` (Server Component)
- **Estado:** RESUELTO

### 6. instrumentation-client.ts conflicto con sentry.client.config.js
- **Sintoma:** Doble inicializacion de Sentry en el cliente
- **Causa:** `instrumentation-client.ts` (nuevo) y `sentry.client.config.js` (importado en `_app.js`) ambos llamaban `Sentry.init()`
- **Fix:** `instrumentation-client.ts` renombrado a `.bak`
- **Estado:** RESUELTO (temporal)

## Archivos modificados en esta sesion

| Archivo | Cambio |
|---------|--------|
| `app/layout.js` | Removidos imports de PixelLoader/CookieBanner (movidos a Providers) |
| `app/providers.js` | AuthGate con isPublicPath + PixelLoader/CookieBanner dentro del client boundary |
| `lib/auth/useAuth.js` | useEffect de checkSession separado del auto-refresh, sin loop |
| `components/analytics/PixelLoader.js` | Agregado `'use client'` |
| `next.config.js` | Restaurado a version del commit (git checkout) |
| `package.json` | Next.js 15.4.11 -> 16.1.6 |
| `app/global-error.js` -> `.bak` | Deshabilitado temporalmente |
| `instrumentation-client.ts` -> `.bak` | Deshabilitado temporalmente |

## Pendientes para proxima sesion

1. **Verificar que Next.js 16.1.6 resuelve el error `originalFactory`** - servidor estaba listo pero no se confirmo en navegador
2. **Testeo manual completo** del flujo: landing -> login -> panel de control
3. **Decidir sobre `global-error.js`** - reactivar con estilos visibles o eliminarlo
4. **Decidir sobre `instrumentation-client.ts`** - migrar Sentry client init correctamente o mantener solo `sentry.client.config.js`
5. **Revisar compatibilidad Sentry 10.38 con Next.js 16** - posibles breaking changes
6. **Commit** de todos los fixes una vez verificados

## Estado del servidor al cerrar
- Servidor activo: `bb08dab` en puerto 3000
- Next.js 16.1.6 con Sentry plugin habilitado (next.config.js original)
- Pendiente: detener servidor antes de cerrar
